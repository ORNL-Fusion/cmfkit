#!/bin/bash


_preflight() {

  CMFKIT_OUTSET_DIR="$( pwd -P )"
  CMFKIT_SOURCE_DIR="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
}


_dugout_init() {

  local readonly outsetdir="$( pwd -P )"
  local readonly cmfkitdir="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
  local rc

  cd $(mktemp -d) || return 1

  #mkdir -p ./cmfkit_coalesce

  cp -r ${outsetdir}/* .
  #cp -r ${outsetdir}/.cmfkit/* ./cmfkit_coalesce

  mkdir -p ./.cmfkit/platform
  mkdir -p ./.cmfkit/scenario
  mkdir -p ./.cmfkit/testbank

  cp -r ${cmfkitdir}/platform/* ./.cmfkit/platform
  cp -r ${cmfkitdir}/scenario/* ./.cmfkit/scenario
  cp -r ${cmfkitdir}/testbank/* ./.cmfkit/testbank

  echo; echo "${PWD}"; tree ; echo; echo

  CMFKIT_DUGOUT_DIR="${PWD}"

  cd - >/dev/null

  #[[ ${OLDPWD} != ${outsetdir} ]] && rm -rf ${OLDPWD}
}



_platform_autodetect() {

  echo
}


_platform_autoselect() {

  CMFKIT_READYBAKE
}


__launch_one() {

  local readonly 
}



__launch_two() {

  shift; local readonly base_image="$1"

  echo "launch_container base_image: ${base_image}"
}


CMFKIT_SOURCE_DIR=''
CMFKIT_OUTSET_DIR=''
CMFKIT_DUGOUT_DIR=''

# CMFKIT_CONTAINER_BASE_IMAGE

# CMFKIT_READYBAKE_BASE_IMAGE
# CMFKIT_PLATFORM [ autoselect nersc github_vm readybake ]
# CMFKIT_SCENARIO [ all default none zilch ]

# CMFKIT_INTERACTIVE [ yes no ]

_preflight

. $CMFKIT_SOURCE_DIR/mod_common
. $CMFKIT_SOURCE_DIR/mod_deflist
. $CMFKIT_SOURCE_DIR/mod_readybake

_dugout_init

echo $CMFKIT_DUGOUT_DIR


CMFKIT_PLATFORM="${CMFKIT_PLATFORM:-autoselect}"
CMFKIT_SCENARIO="${CMFKIT_SCENARIO:-default}"

CMFKIT_READYBAKE_BUILD_PATH=''
CMFKIT_READYBAKE_BASE_IMAGE='alpine:3.14.2'

[[ -n "$CMFKIT_READYBAKE_BASE_IMAGE" ]] \
  && [[ $CMFKIT_PLATFORM =~ autoselect|readybake ]] \
  && CMFKIT_PLATFORM="readybake"

[[ $CMFKIT_PLATFORM =~ readybake ]] \
  && (    _readybake_match_build_path "$CMFKIT_READYBAKE_BASE_IMAGE" \
       || _error_fatal "unable to locate build path for $CMFKIT_READYBAKE_BASE_IMAGE" )

[[ $CMFKIT_PLATFORM =~ readybake ]] \
  || _readybake_yield_image \
  || _error_fatal "_readybake_yield_image() failed" \




echo; echo; _debug_dumpvars | grep "CMFKIT_" ; echo; echo

rm -rf $CMFKIT_DUGOUT_DIR


#[[ -z "$1" ]] && "__launch"
#[[ -z "$1" ]] || "__launch_$1" "$@"

#_readybake_yield_image
#_readybake_buildenv

