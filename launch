#!/bin/bash


_preflight() {

  CMFKIT_OUTSET_DIR="$( pwd -P )"
  CMFKIT_SOURCE_DIR="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
}


_dugout_init() {

  local readonly outsetdir="$( pwd -P )"
  local readonly cmfkitdir="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
  local rc

  cd $(mktemp -d) || return 1

  #mkdir -p ./cmfkit_coalesce

  cp -r ${outsetdir}/* .
  #cp -r ${outsetdir}/.cmfkit/* ./cmfkit_coalesce

  mkdir -p ./.cmfkit/platform
  mkdir -p ./.cmfkit/scenario
  mkdir -p ./.cmfkit/testbank

  cp -r ${cmfkitdir}/platform/* ./.cmfkit/platform
  cp -r ${cmfkitdir}/scenario/* ./.cmfkit/scenario
  cp -r ${cmfkitdir}/testbank/* ./.cmfkit/testbank

  echo; echo "${PWD}"

  CMFKIT_DUGOUT_DIR="${PWD}"

  cd - >/dev/null

  #[[ ${OLDPWD} != ${outsetdir} ]] && rm -rf ${OLDPWD}
}



_platform_autodetect() {

  echo
}


_platform_autoselect() {

  echo "invoke _platform_autoselect()"
}


__launch_one() {

  local readonly 
}



__launch_two() {

  shift; local readonly base_image="$1"

  echo "launch_container base_image: ${base_image}"
}


CMFKIT_SOURCE_DIR=''
CMFKIT_OUTSET_DIR=''
CMFKIT_DUGOUT_DIR=''

# CMFKIT_CONTAINER_BASE_IMAGE

# CMFKIT_READYBAKE_BASE_IMAGE
# CMFKIT_PLATFORM [ autoselect nersc github_vm readybake ]
# CMFKIT_SCENARIO [ all default none zilch ]

# CMFKIT_INTERACTIVE [ yes no ]

_preflight

. $CMFKIT_SOURCE_DIR/mod_common
. $CMFKIT_SOURCE_DIR/mod_deflist
. $CMFKIT_SOURCE_DIR/mod_readybake

_dugout_init

echo $CMFKIT_DUGOUT_DIR



CMFKIT_PLATFORM="${CMFKIT_PLATFORM:-unknown}"
CMFKIT_SCENARIO="${CMFKIT_SCENARIO:-default}"
#CMFKIT_READYBAKE_IMAGE_BASE="${CMFKIT_READYBAKE_IMAGE_BASE:-}"

CMFKIT_READYBAKE_BUILD_PATH=''

echo; echo; _debug_dumpvars | grep "CMFKIT_" ; echo; echo

[[ -n "$CMFKIT_READYBAKE_BASE_IMAGE" ]] \
  && _readybake_isolate_buildpath "$CMFKIT_READYBAKE_BASE_IMAGE"

[[ $CMFKIT_PLATFORM =~ readybake ]] \
  && [[ -z "$CMFKIT_READYBAKE_BUILD_PATH" ]] \
  && _error_fatal "unable to isolate Dockerfile for $CMFKIT_READYBAKE_BASE_IMAGE"

[[ $CMFKIT_PLATFORM =~ readybake ]]  && _readybake_yield_image
[[ -z "$CMFKIT_READYBAKE_IMAGE"  ]]  && _error_fatal "unable to yield image"

[[ $CMFKIT_PLATFORM =~ unknown ]]  && _platform_autoselect
[[ $CMFKIT_PLATFORM =~ unknown ]]  && _error_fatal "unable to select platform"






rm -rf $CMFKIT_DUGOUT_DIR


#[[ -z "$1" ]] && "__launch"
#[[ -z "$1" ]] || "__launch_$1" "$@"

#_readybake_yield_image
#_readybake_buildenv

